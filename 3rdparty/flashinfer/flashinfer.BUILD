load("@//:def.bzl", "copts", "cuda_copts")
load("@local_config_cuda//cuda:build_defs.bzl", "cuda_default_copts_without_arch", "if_cuda")
load("@//bazel:arch_select.bzl", "torch_deps")
load("@//3rdparty/flashinfer:def.bzl", "sub_lib")

common_copts = [
    '-DFLASHINFER_ENABLE_BF16',
    '-DFLASHINFER_ENABLE_FP8',
]

sm90_cuda_copts = copts() + cuda_default_copts_without_arch() + if_cuda(["-nvcc_options=objdir-as-tempdir"]) + [
    '--cuda-include-ptx=sm_90', '--cuda-gpu-arch=sm_90',
    '--cuda-include-ptx=sm_90a', '--cuda-gpu-arch=sm_90a',
] + common_copts

cc_library(
    name = "dispatch",
    hdrs = ["dispatch.inc"],
    include_prefix = "generated",
    copts = cuda_copts() + common_copts,
)

cc_library(
    name = "flashinfer_hdrs",
    hdrs = glob([
        "include/flashinfer/**/*.cuh",
        "include/flashinfer/**/*.h",
    ]) + [
        ":dispatch",
    ],
    deps = [
        "@cutlass3.6//:cutlass",
        "@cutlass3.6//:cutlass_utils",
        "@local_config_cuda//cuda:cuda_headers",
        "@local_config_cuda//cuda:cudart",
        "@local_config_cuda//cuda:cublas_headers",
        "@local_config_cuda//cuda:cublas",
        "@local_config_cuda//cuda:cublasLt",
    ] + torch_deps(),
    strip_include_prefix = "include",
    copts = cuda_copts() + common_copts,
    visibility = ["//visibility:public"],
)

py_library(
    name = "aot_build_utils",
    srcs = glob(['aot_build_utils/*.py']),
)

py_library(
    name = "aot_build_utils_generate_sm90",
    srcs = ['aot_build_utils/generate_sm90.py'],
    deps = [":aot_build_utils"],
)

py_library(
    name = "aot_build_utils_generate",
    srcs = ['aot_build_utils/generate.py'],
    deps = [":aot_build_utils"],
)

genrule(
    name = "generated_sm90",
    tools = [":aot_build_utils_generate_sm90"],
    cmd = "loc=$(locations @flashinfer//:aot_build_utils_generate_sm90); loc=$${loc%/*};loc=$${loc%/*}; PYTHONPATH=$$loc /opt/conda310/bin/python -m aot_build_utils.generate_sm90 --enable_fp8 true --enable_bf16 true --mask_modes 1 --path $(RULEDIR) --head_dims 64 128 --pos_encoding_modes 0 --allow_fp16_qk_reductions false",
    outs = [
        'batch_paged_prefill_head_128_posenc_0_fp16qkred_0_mask_1_dtypeq_bf16_dtypekv_bf16_dtypeout_bf16_idtype_i32_sm90.cu',
        'batch_paged_prefill_head_128_posenc_0_fp16qkred_0_mask_1_dtypeq_f16_dtypekv_f16_dtypeout_f16_idtype_i32_sm90.cu',
        'batch_paged_prefill_head_64_posenc_0_fp16qkred_0_mask_1_dtypeq_bf16_dtypekv_bf16_dtypeout_bf16_idtype_i32_sm90.cu',
        'batch_paged_prefill_head_64_posenc_0_fp16qkred_0_mask_1_dtypeq_f16_dtypekv_f16_dtypeout_f16_idtype_i32_sm90.cu',
        'batch_ragged_prefill_head_128_posenc_0_fp16qkred_0_mask_1_dtypeq_bf16_dtypekv_bf16_dtypeout_bf16_idtype_i32_sm90.cu',
        'batch_ragged_prefill_head_128_posenc_0_fp16qkred_0_mask_1_dtypeq_f16_dtypekv_f16_dtypeout_f16_idtype_i32_sm90.cu',
        'batch_ragged_prefill_head_64_posenc_0_fp16qkred_0_mask_1_dtypeq_bf16_dtypekv_bf16_dtypeout_bf16_idtype_i32_sm90.cu',
        'batch_ragged_prefill_head_64_posenc_0_fp16qkred_0_mask_1_dtypeq_f16_dtypekv_f16_dtypeout_f16_idtype_i32_sm90.cu',
        'single_prefill_head_128_posenc_0_fp16qkred_0_mask_1_dtypeq_bf16_dtypekv_bf16_dtypeout_bf16_sm90.cu',
        'single_prefill_head_128_posenc_0_fp16qkred_0_mask_1_dtypeq_f16_dtypekv_f16_dtypeout_f16_sm90.cu',
        'single_prefill_head_64_posenc_0_fp16qkred_0_mask_1_dtypeq_bf16_dtypekv_bf16_dtypeout_bf16_sm90.cu',
        'single_prefill_head_64_posenc_0_fp16qkred_0_mask_1_dtypeq_f16_dtypekv_f16_dtypeout_f16_sm90.cu',
    ],
    tags=["local"],
)

genrule(
    name = "generated",
    tools = [":aot_build_utils_generate"],
    cmd = "loc=$(locations @flashinfer//:aot_build_utils_generate); loc=$${loc%/*};loc=$${loc%/*}; PYTHONPATH=$$loc /opt/conda310/bin/python -m aot_build_utils.generate --enable_fp8 true --enable_bf16 true --mask_modes 1 --path $(RULEDIR) --head_dims 64 128 --pos_encoding_modes 0 --allow_fp16_qk_reductions false",
    outs = [
        'batch_paged_decode_head_128_posenc_0_dtypeq_bf16_dtypekv_bf16_dtypeout_bf16_idtype_i32.cu',
        'batch_paged_decode_head_128_posenc_0_dtypeq_bf16_dtypekv_e4m3_dtypeout_bf16_idtype_i32.cu',
        'batch_paged_decode_head_128_posenc_0_dtypeq_bf16_dtypekv_e5m2_dtypeout_bf16_idtype_i32.cu',
        'batch_paged_decode_head_128_posenc_0_dtypeq_e4m3_dtypekv_e4m3_dtypeout_e4m3_idtype_i32.cu',
        'batch_paged_decode_head_128_posenc_0_dtypeq_e5m2_dtypekv_e5m2_dtypeout_e5m2_idtype_i32.cu',
        'batch_paged_decode_head_128_posenc_0_dtypeq_f16_dtypekv_e4m3_dtypeout_f16_idtype_i32.cu',
        'batch_paged_decode_head_128_posenc_0_dtypeq_f16_dtypekv_e5m2_dtypeout_f16_idtype_i32.cu',
        'batch_paged_decode_head_128_posenc_0_dtypeq_f16_dtypekv_f16_dtypeout_f16_idtype_i32.cu',
        'batch_paged_decode_head_64_posenc_0_dtypeq_bf16_dtypekv_bf16_dtypeout_bf16_idtype_i32.cu',
        'batch_paged_decode_head_64_posenc_0_dtypeq_bf16_dtypekv_e4m3_dtypeout_bf16_idtype_i32.cu',
        'batch_paged_decode_head_64_posenc_0_dtypeq_bf16_dtypekv_e5m2_dtypeout_bf16_idtype_i32.cu',
        'batch_paged_decode_head_64_posenc_0_dtypeq_e4m3_dtypekv_e4m3_dtypeout_e4m3_idtype_i32.cu',
        'batch_paged_decode_head_64_posenc_0_dtypeq_e5m2_dtypekv_e5m2_dtypeout_e5m2_idtype_i32.cu',
        'batch_paged_decode_head_64_posenc_0_dtypeq_f16_dtypekv_e4m3_dtypeout_f16_idtype_i32.cu',
        'batch_paged_decode_head_64_posenc_0_dtypeq_f16_dtypekv_e5m2_dtypeout_f16_idtype_i32.cu',
        'batch_paged_decode_head_64_posenc_0_dtypeq_f16_dtypekv_f16_dtypeout_f16_idtype_i32.cu',
        'batch_paged_prefill_head_128_posenc_0_fp16qkred_0_mask_1_dtypeq_bf16_dtypekv_bf16_dtypeout_bf16_idtype_i32.cu',
        'batch_paged_prefill_head_128_posenc_0_fp16qkred_0_mask_1_dtypeq_bf16_dtypekv_e4m3_dtypeout_bf16_idtype_i32.cu',
        'batch_paged_prefill_head_128_posenc_0_fp16qkred_0_mask_1_dtypeq_bf16_dtypekv_e5m2_dtypeout_bf16_idtype_i32.cu',
        'batch_paged_prefill_head_128_posenc_0_fp16qkred_0_mask_1_dtypeq_f16_dtypekv_e4m3_dtypeout_f16_idtype_i32.cu',
        'batch_paged_prefill_head_128_posenc_0_fp16qkred_0_mask_1_dtypeq_f16_dtypekv_e5m2_dtypeout_f16_idtype_i32.cu',
        'batch_paged_prefill_head_128_posenc_0_fp16qkred_0_mask_1_dtypeq_f16_dtypekv_f16_dtypeout_f16_idtype_i32.cu',
        'batch_paged_prefill_head_64_posenc_0_fp16qkred_0_mask_1_dtypeq_bf16_dtypekv_bf16_dtypeout_bf16_idtype_i32.cu',
        'batch_paged_prefill_head_64_posenc_0_fp16qkred_0_mask_1_dtypeq_bf16_dtypekv_e4m3_dtypeout_bf16_idtype_i32.cu',
        'batch_paged_prefill_head_64_posenc_0_fp16qkred_0_mask_1_dtypeq_bf16_dtypekv_e5m2_dtypeout_bf16_idtype_i32.cu',
        'batch_paged_prefill_head_64_posenc_0_fp16qkred_0_mask_1_dtypeq_f16_dtypekv_e4m3_dtypeout_f16_idtype_i32.cu',
        'batch_paged_prefill_head_64_posenc_0_fp16qkred_0_mask_1_dtypeq_f16_dtypekv_e5m2_dtypeout_f16_idtype_i32.cu',
        'batch_paged_prefill_head_64_posenc_0_fp16qkred_0_mask_1_dtypeq_f16_dtypekv_f16_dtypeout_f16_idtype_i32.cu',
        'batch_ragged_prefill_head_128_posenc_0_fp16qkred_0_mask_1_dtypeq_bf16_dtypekv_bf16_dtypeout_bf16_idtype_i32.cu',
        'batch_ragged_prefill_head_128_posenc_0_fp16qkred_0_mask_1_dtypeq_bf16_dtypekv_e4m3_dtypeout_bf16_idtype_i32.cu',
        'batch_ragged_prefill_head_128_posenc_0_fp16qkred_0_mask_1_dtypeq_bf16_dtypekv_e5m2_dtypeout_bf16_idtype_i32.cu',
        'batch_ragged_prefill_head_128_posenc_0_fp16qkred_0_mask_1_dtypeq_f16_dtypekv_e4m3_dtypeout_f16_idtype_i32.cu',
        'batch_ragged_prefill_head_128_posenc_0_fp16qkred_0_mask_1_dtypeq_f16_dtypekv_e5m2_dtypeout_f16_idtype_i32.cu',
        'batch_ragged_prefill_head_128_posenc_0_fp16qkred_0_mask_1_dtypeq_f16_dtypekv_f16_dtypeout_f16_idtype_i32.cu',
        'batch_ragged_prefill_head_64_posenc_0_fp16qkred_0_mask_1_dtypeq_bf16_dtypekv_bf16_dtypeout_bf16_idtype_i32.cu',
        'batch_ragged_prefill_head_64_posenc_0_fp16qkred_0_mask_1_dtypeq_bf16_dtypekv_e4m3_dtypeout_bf16_idtype_i32.cu',
        'batch_ragged_prefill_head_64_posenc_0_fp16qkred_0_mask_1_dtypeq_bf16_dtypekv_e5m2_dtypeout_bf16_idtype_i32.cu',
        'batch_ragged_prefill_head_64_posenc_0_fp16qkred_0_mask_1_dtypeq_f16_dtypekv_e4m3_dtypeout_f16_idtype_i32.cu',
        'batch_ragged_prefill_head_64_posenc_0_fp16qkred_0_mask_1_dtypeq_f16_dtypekv_e5m2_dtypeout_f16_idtype_i32.cu',
        'batch_ragged_prefill_head_64_posenc_0_fp16qkred_0_mask_1_dtypeq_f16_dtypekv_f16_dtypeout_f16_idtype_i32.cu',
        'dispatch.inc',
        'single_decode_head_128_posenc_0_dtypeq_bf16_dtypekv_bf16_dtypeout_bf16.cu',
        'single_decode_head_128_posenc_0_dtypeq_bf16_dtypekv_e4m3_dtypeout_bf16.cu',
        'single_decode_head_128_posenc_0_dtypeq_bf16_dtypekv_e5m2_dtypeout_bf16.cu',
        'single_decode_head_128_posenc_0_dtypeq_e4m3_dtypekv_e4m3_dtypeout_e4m3.cu',
        'single_decode_head_128_posenc_0_dtypeq_e5m2_dtypekv_e5m2_dtypeout_e5m2.cu',
        'single_decode_head_128_posenc_0_dtypeq_f16_dtypekv_e4m3_dtypeout_f16.cu',
        'single_decode_head_128_posenc_0_dtypeq_f16_dtypekv_e5m2_dtypeout_f16.cu',
        'single_decode_head_128_posenc_0_dtypeq_f16_dtypekv_f16_dtypeout_f16.cu',
        'single_decode_head_64_posenc_0_dtypeq_bf16_dtypekv_bf16_dtypeout_bf16.cu',
        'single_decode_head_64_posenc_0_dtypeq_bf16_dtypekv_e4m3_dtypeout_bf16.cu',
        'single_decode_head_64_posenc_0_dtypeq_bf16_dtypekv_e5m2_dtypeout_bf16.cu',
        'single_decode_head_64_posenc_0_dtypeq_e4m3_dtypekv_e4m3_dtypeout_e4m3.cu',
        'single_decode_head_64_posenc_0_dtypeq_e5m2_dtypekv_e5m2_dtypeout_e5m2.cu',
        'single_decode_head_64_posenc_0_dtypeq_f16_dtypekv_e4m3_dtypeout_f16.cu',
        'single_decode_head_64_posenc_0_dtypeq_f16_dtypekv_e5m2_dtypeout_f16.cu',
        'single_decode_head_64_posenc_0_dtypeq_f16_dtypekv_f16_dtypeout_f16.cu',
        'single_prefill_head_128_posenc_0_fp16qkred_0_mask_1_dtypeq_bf16_dtypekv_bf16_dtypeout_bf16.cu',
        'single_prefill_head_128_posenc_0_fp16qkred_0_mask_1_dtypeq_bf16_dtypekv_e4m3_dtypeout_bf16.cu',
        'single_prefill_head_128_posenc_0_fp16qkred_0_mask_1_dtypeq_bf16_dtypekv_e5m2_dtypeout_bf16.cu',
        'single_prefill_head_128_posenc_0_fp16qkred_0_mask_1_dtypeq_f16_dtypekv_e4m3_dtypeout_f16.cu',
        'single_prefill_head_128_posenc_0_fp16qkred_0_mask_1_dtypeq_f16_dtypekv_e5m2_dtypeout_f16.cu',
        'single_prefill_head_128_posenc_0_fp16qkred_0_mask_1_dtypeq_f16_dtypekv_f16_dtypeout_f16.cu',
        'single_prefill_head_64_posenc_0_fp16qkred_0_mask_1_dtypeq_bf16_dtypekv_bf16_dtypeout_bf16.cu',
        'single_prefill_head_64_posenc_0_fp16qkred_0_mask_1_dtypeq_bf16_dtypekv_e4m3_dtypeout_bf16.cu',
        'single_prefill_head_64_posenc_0_fp16qkred_0_mask_1_dtypeq_bf16_dtypekv_e5m2_dtypeout_bf16.cu',
        'single_prefill_head_64_posenc_0_fp16qkred_0_mask_1_dtypeq_f16_dtypekv_e4m3_dtypeout_f16.cu',
        'single_prefill_head_64_posenc_0_fp16qkred_0_mask_1_dtypeq_f16_dtypekv_e5m2_dtypeout_f16.cu',
        'single_prefill_head_64_posenc_0_fp16qkred_0_mask_1_dtypeq_f16_dtypekv_f16_dtypeout_f16.cu',
    ],
    tags=["local"],
)

f0 = [
    'dispatch.inc',
    'batch_paged_decode_head_128_posenc_0_dtypeq_bf16_dtypekv_bf16_dtypeout_bf16_idtype_i32.cu',
    'batch_paged_decode_head_128_posenc_0_dtypeq_bf16_dtypekv_e4m3_dtypeout_bf16_idtype_i32.cu',
    'batch_paged_decode_head_128_posenc_0_dtypeq_bf16_dtypekv_e5m2_dtypeout_bf16_idtype_i32.cu',
    'batch_paged_decode_head_128_posenc_0_dtypeq_e4m3_dtypekv_e4m3_dtypeout_e4m3_idtype_i32.cu',
    'batch_paged_decode_head_128_posenc_0_dtypeq_e5m2_dtypekv_e5m2_dtypeout_e5m2_idtype_i32.cu',
    'batch_paged_decode_head_128_posenc_0_dtypeq_f16_dtypekv_e4m3_dtypeout_f16_idtype_i32.cu',
    'batch_paged_decode_head_128_posenc_0_dtypeq_f16_dtypekv_e5m2_dtypeout_f16_idtype_i32.cu',
    'batch_paged_decode_head_128_posenc_0_dtypeq_f16_dtypekv_f16_dtypeout_f16_idtype_i32.cu',
    'batch_paged_decode_head_64_posenc_0_dtypeq_bf16_dtypekv_bf16_dtypeout_bf16_idtype_i32.cu',
    'batch_paged_decode_head_64_posenc_0_dtypeq_bf16_dtypekv_e4m3_dtypeout_bf16_idtype_i32.cu',
    'batch_paged_decode_head_64_posenc_0_dtypeq_bf16_dtypekv_e5m2_dtypeout_bf16_idtype_i32.cu',
    'batch_paged_decode_head_64_posenc_0_dtypeq_e4m3_dtypekv_e4m3_dtypeout_e4m3_idtype_i32.cu',
    'batch_paged_decode_head_64_posenc_0_dtypeq_e5m2_dtypekv_e5m2_dtypeout_e5m2_idtype_i32.cu',
    'batch_paged_decode_head_64_posenc_0_dtypeq_f16_dtypekv_e4m3_dtypeout_f16_idtype_i32.cu',
    'batch_paged_decode_head_64_posenc_0_dtypeq_f16_dtypekv_e5m2_dtypeout_f16_idtype_i32.cu',
    'batch_paged_decode_head_64_posenc_0_dtypeq_f16_dtypekv_f16_dtypeout_f16_idtype_i32.cu',
    'batch_paged_prefill_head_128_posenc_0_fp16qkred_0_mask_1_dtypeq_bf16_dtypekv_bf16_dtypeout_bf16_idtype_i32.cu',
    'batch_paged_prefill_head_128_posenc_0_fp16qkred_0_mask_1_dtypeq_bf16_dtypekv_e4m3_dtypeout_bf16_idtype_i32.cu',
    'batch_paged_prefill_head_128_posenc_0_fp16qkred_0_mask_1_dtypeq_bf16_dtypekv_e5m2_dtypeout_bf16_idtype_i32.cu',
    'batch_paged_prefill_head_128_posenc_0_fp16qkred_0_mask_1_dtypeq_f16_dtypekv_e4m3_dtypeout_f16_idtype_i32.cu',
    'batch_paged_prefill_head_128_posenc_0_fp16qkred_0_mask_1_dtypeq_f16_dtypekv_e5m2_dtypeout_f16_idtype_i32.cu',
    'batch_paged_prefill_head_128_posenc_0_fp16qkred_0_mask_1_dtypeq_f16_dtypekv_f16_dtypeout_f16_idtype_i32.cu',
    'batch_paged_prefill_head_64_posenc_0_fp16qkred_0_mask_1_dtypeq_bf16_dtypekv_bf16_dtypeout_bf16_idtype_i32.cu',
    'batch_paged_prefill_head_64_posenc_0_fp16qkred_0_mask_1_dtypeq_bf16_dtypekv_e4m3_dtypeout_bf16_idtype_i32.cu',
    'batch_paged_prefill_head_64_posenc_0_fp16qkred_0_mask_1_dtypeq_bf16_dtypekv_e5m2_dtypeout_bf16_idtype_i32.cu',
    'batch_paged_prefill_head_64_posenc_0_fp16qkred_0_mask_1_dtypeq_f16_dtypekv_e4m3_dtypeout_f16_idtype_i32.cu',
    'batch_paged_prefill_head_64_posenc_0_fp16qkred_0_mask_1_dtypeq_f16_dtypekv_e5m2_dtypeout_f16_idtype_i32.cu',
    'batch_paged_prefill_head_64_posenc_0_fp16qkred_0_mask_1_dtypeq_f16_dtypekv_f16_dtypeout_f16_idtype_i32.cu',
    'batch_ragged_prefill_head_128_posenc_0_fp16qkred_0_mask_1_dtypeq_bf16_dtypekv_bf16_dtypeout_bf16_idtype_i32.cu',
    'batch_ragged_prefill_head_128_posenc_0_fp16qkred_0_mask_1_dtypeq_bf16_dtypekv_e4m3_dtypeout_bf16_idtype_i32.cu',
    'batch_ragged_prefill_head_128_posenc_0_fp16qkred_0_mask_1_dtypeq_bf16_dtypekv_e5m2_dtypeout_bf16_idtype_i32.cu',
    'batch_ragged_prefill_head_128_posenc_0_fp16qkred_0_mask_1_dtypeq_f16_dtypekv_e4m3_dtypeout_f16_idtype_i32.cu',
    'batch_ragged_prefill_head_128_posenc_0_fp16qkred_0_mask_1_dtypeq_f16_dtypekv_e5m2_dtypeout_f16_idtype_i32.cu',
    'batch_ragged_prefill_head_128_posenc_0_fp16qkred_0_mask_1_dtypeq_f16_dtypekv_f16_dtypeout_f16_idtype_i32.cu',
    'batch_ragged_prefill_head_64_posenc_0_fp16qkred_0_mask_1_dtypeq_bf16_dtypekv_bf16_dtypeout_bf16_idtype_i32.cu',
    'batch_ragged_prefill_head_64_posenc_0_fp16qkred_0_mask_1_dtypeq_bf16_dtypekv_e4m3_dtypeout_bf16_idtype_i32.cu',
    'batch_ragged_prefill_head_64_posenc_0_fp16qkred_0_mask_1_dtypeq_bf16_dtypekv_e5m2_dtypeout_bf16_idtype_i32.cu',
    'batch_ragged_prefill_head_64_posenc_0_fp16qkred_0_mask_1_dtypeq_f16_dtypekv_e4m3_dtypeout_f16_idtype_i32.cu',
    'batch_ragged_prefill_head_64_posenc_0_fp16qkred_0_mask_1_dtypeq_f16_dtypekv_e5m2_dtypeout_f16_idtype_i32.cu',
    'batch_ragged_prefill_head_64_posenc_0_fp16qkred_0_mask_1_dtypeq_f16_dtypekv_f16_dtypeout_f16_idtype_i32.cu',
]

f1 = [
    'dispatch.inc',
    'single_decode_head_128_posenc_0_dtypeq_bf16_dtypekv_bf16_dtypeout_bf16.cu',
    'single_decode_head_128_posenc_0_dtypeq_bf16_dtypekv_e4m3_dtypeout_bf16.cu',
    'single_decode_head_128_posenc_0_dtypeq_bf16_dtypekv_e5m2_dtypeout_bf16.cu',
    'single_decode_head_128_posenc_0_dtypeq_e4m3_dtypekv_e4m3_dtypeout_e4m3.cu',
    'single_decode_head_128_posenc_0_dtypeq_e5m2_dtypekv_e5m2_dtypeout_e5m2.cu',
    'single_decode_head_128_posenc_0_dtypeq_f16_dtypekv_e4m3_dtypeout_f16.cu',
    'single_decode_head_128_posenc_0_dtypeq_f16_dtypekv_e5m2_dtypeout_f16.cu',
    'single_decode_head_128_posenc_0_dtypeq_f16_dtypekv_f16_dtypeout_f16.cu',
    'single_decode_head_64_posenc_0_dtypeq_bf16_dtypekv_bf16_dtypeout_bf16.cu',
    'single_decode_head_64_posenc_0_dtypeq_bf16_dtypekv_e4m3_dtypeout_bf16.cu',
    'single_decode_head_64_posenc_0_dtypeq_bf16_dtypekv_e5m2_dtypeout_bf16.cu',
    'single_decode_head_64_posenc_0_dtypeq_e4m3_dtypekv_e4m3_dtypeout_e4m3.cu',
    'single_decode_head_64_posenc_0_dtypeq_e5m2_dtypekv_e5m2_dtypeout_e5m2.cu',
    'single_decode_head_64_posenc_0_dtypeq_f16_dtypekv_e4m3_dtypeout_f16.cu',
    'single_decode_head_64_posenc_0_dtypeq_f16_dtypekv_e5m2_dtypeout_f16.cu',
    'single_decode_head_64_posenc_0_dtypeq_f16_dtypekv_f16_dtypeout_f16.cu',
    'single_prefill_head_128_posenc_0_fp16qkred_0_mask_1_dtypeq_bf16_dtypekv_bf16_dtypeout_bf16.cu',
    'single_prefill_head_128_posenc_0_fp16qkred_0_mask_1_dtypeq_bf16_dtypekv_e4m3_dtypeout_bf16.cu',
    'single_prefill_head_128_posenc_0_fp16qkred_0_mask_1_dtypeq_bf16_dtypekv_e5m2_dtypeout_bf16.cu',
    'single_prefill_head_128_posenc_0_fp16qkred_0_mask_1_dtypeq_f16_dtypekv_e4m3_dtypeout_f16.cu',
    'single_prefill_head_128_posenc_0_fp16qkred_0_mask_1_dtypeq_f16_dtypekv_e5m2_dtypeout_f16.cu',
    'single_prefill_head_128_posenc_0_fp16qkred_0_mask_1_dtypeq_f16_dtypekv_f16_dtypeout_f16.cu',
    'single_prefill_head_64_posenc_0_fp16qkred_0_mask_1_dtypeq_bf16_dtypekv_bf16_dtypeout_bf16.cu',
    'single_prefill_head_64_posenc_0_fp16qkred_0_mask_1_dtypeq_bf16_dtypekv_e4m3_dtypeout_bf16.cu',
    'single_prefill_head_64_posenc_0_fp16qkred_0_mask_1_dtypeq_bf16_dtypekv_e5m2_dtypeout_bf16.cu',
    'single_prefill_head_64_posenc_0_fp16qkred_0_mask_1_dtypeq_f16_dtypekv_e4m3_dtypeout_f16.cu',
    'single_prefill_head_64_posenc_0_fp16qkred_0_mask_1_dtypeq_f16_dtypekv_e5m2_dtypeout_f16.cu',
    'single_prefill_head_64_posenc_0_fp16qkred_0_mask_1_dtypeq_f16_dtypekv_f16_dtypeout_f16.cu',
]

cc_library(
    name = "flashinfer",
    srcs = [
        "csrc/activation.cu",
        "csrc/batch_decode.cu",
        "csrc/batch_prefill.cu",
        "csrc/batch_prefill_sm90.cu",
        "csrc/bmm_fp8.cu",
        "csrc/cascade.cu",
        "csrc/group_gemm.cu",
        "csrc/group_gemm_sm90.cu",
        "csrc/norm.cu",
        "csrc/page.cu",
        "csrc/quantization.cu",
        "csrc/renorm.cu",
        "csrc/rope.cu",
        "csrc/sampling.cu",
        "csrc/single_decode.cu",
        "csrc/single_prefill.cu",
        "csrc/single_prefill_sm90.cu",
    ] + glob([
        "csrc/*.h",
    ]) + [
        sub_lib('flashinfer_0', f0, cuda_copts() + common_copts),
        sub_lib('flashinfer_1', f1, cuda_copts() + common_copts),
        sub_lib('flashinfer_2', [":generated_sm90"], sm90_cuda_copts),
    ],
    implementation_deps = [
        ":dispatch",
        ":flashinfer_hdrs",
    ],
    copts = cuda_copts() + common_copts,
    visibility = ["//visibility:public"],
)
